<template>
	<div class="card" :class="{ loading }" @click="handleClick">
		<div class="header" :class="{ selected: value.includes(item) }">
			<div class="selection-indicator" :class="{ 'needs-shadow': !!imageSource }">
				<v-icon :name="selectionIcon" @click.stop="toggleSelection" />
			</div>
			<v-skeleton-loader v-if="loading" />
			<template v-else>
				<p v-if="type" class="type type-title">{{ type }}</p>
				<template v-else>
					<img v-if="imageSource" :src="imageSource" />
					<v-icon v-else large :name="icon" />
				</template>
			</template>
		</div>
		<v-skeleton-loader v-if="loading" type="text" />
		<template v-else>
			<div class="title" v-if="$slots.title"><slot name="title" /></div>
			<div class="subtitle" v-if="$slots.subtitle"><slot name="subtitle" /></div>
		</template>
	</div>
</template>

<script lang="ts">
import { defineComponent, PropType, computed } from '@vue/composition-api';
import router from '@/router';

type File = {
	// eslint-disable-next-line @typescript-eslint/no-explicit-any
	[key: string]: any;
	type: string;
	data: {
		thumbnails: {
			key: string;
			url: string;
		}[];
	};
};

export default defineComponent({
	props: {
		icon: {
			type: String,
			default: 'box',
		},
		file: {
			type: Object as PropType<File>,
			default: null,
		},
		crop: {
			type: Boolean,
			default: false,
		},
		loading: {
			type: Boolean,
			default: false,
		},
		item: {
			type: Object as PropType<Record<string, any>>,
			default: null,
		},
		value: {
			type: Array as PropType<Record<string, any>[]>,
			default: () => [],
		},
		selectMode: {
			type: Boolean,
			default: false,
		},
		to: {
			type: String,
			default: '',
		},
	},
	setup(props, { emit }) {
		const type = computed(() => {
			if (props.file === null) return null;
			if (props.file.type.startsWith('image')) return null;
			return props.file.type.split('/')[1];
		});

		const imageSource = computed(() => {
			if (props.file === null) return null;
			if (props.file.type.startsWith('image') === false) return null;
			if (props.file.type.includes('svg')) return null;

			let key = 'directus-medium-crop';

			if (props.crop === false) {
				key = 'directus-medium-contain';
			}

			const thumbnail = props.file.data.thumbnails.find((thumbnail) => thumbnail.key === key);

			if (!thumbnail) return null;

			return thumbnail.url;
		});

		const selectionIcon = computed(() =>
			props.value.includes(props.item) ? 'check_circle' : 'radio_button_unchecked'
		);

		return { imageSource, type, selectionIcon, toggleSelection, handleClick };

		function toggleSelection() {
			if (props.value.includes(props.item)) {
				emit(
					'input',
					props.value.filter((item) => item !== props.item)
				);
			} else {
				emit('input', [...props.value, props.item]);
			}
		}

		function handleClick() {
			if (props.selectMode === true) {
				toggleSelection();
			} else {
				router.push(props.to);
			}
		}
	},
});
</script>

<style lang="scss" scoped>
.card {
	cursor: pointer;
}

.header {
	position: relative;
	display: flex;
	align-items: center;
	justify-content: center;
	width: var(--size);
	height: var(--size);
	overflow: hidden;
	background-color: var(--background-normal);
	border-radius: var(--border-radius);

	&.selected {
		background-color: var(--background-normal-alt);
	}

	img {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
	}

	.type {
		color: var(--foreground-subdued);
		text-transform: uppercase;
	}

	.v-icon {
		--v-icon-color: var(--foreground-subdued);
	}

	::v-deep .v-skeleton-loader {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
	}

	.selection-indicator {
		position: absolute;
		top: 0;
		left: 0;
		z-index: 1;
		width: 100%;
		height: 30%;

		.v-icon {
			--v-icon-color: var(--white);

			margin: 5%;
		}

		&.needs-shadow::before {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-image: linear-gradient(-180deg, #263238 10%, rgba(38, 50, 56, 0));
			opacity: 0.3;
			content: '';
		}
	}
}

.loading {
	.header {
		margin-bottom: 8px;
	}
}

.title,
.subtitle {
	width: 100%;
	overflow: hidden;
	line-height: 1.3em;
	white-space: nowrap;
	text-overflow: ellipsis;
}

.title {
	margin-top: 4px;
}

.subtitle {
	color: var(--foreground-subdued);
}
</style>
